# RPi_CODESYS_CNC

Raspberry Pi + CODESYS(SoftMotion CNC/ROBOTICS) でどこまで汎用のCNCが作れるか挑戦しています。

現時点では、EtherCATで設定し、サーボドライブが無くても実行・検証できるよう、仮想EtherCATドライブで実行できるようにしています。

PCで仮想サーボドライブで正しく実装されたら、RPi+EtherCATサーボドライブでテストしてみようと思います。

EtherCATデバイス（ACサーボドライブの機材など）で、もし不要なものがありましたら、譲渡・貸与頂けると、とても助かります。

---

##開発の経緯と意義

CODESYSのCNCは、DIN66025のGコードをサポートしますが、機能がやや限られています。

DIN66025についてはこちら
https://help.codesys.com/webapp/_sm_cnc_din66025_basics;product=codesys_softmotion;version=4.6.0.0

CODESYSのCNC機能で機械システムを作ろうとしたときに、DIN66025にはないFANUCやSIEMENSのCNCの機能をどのように実装していいか、どういう機能がどれくらい出来るのか、出来ないのか、マニュアル等ではよくわからないのが実情です。

良い点としては、CODESYSでは、
１）6万以上のMコードをユーザーが自由に使用して拡張ができ、２つの浮動小数のパラメータを渡すことができます。
２）Gコード内にキーワードを置いて、実行中のCODESYS内の変数で置換して使用することができます。

これらを使い、PC側で単純な置換をすることで、CNCのプログラムをCODESYSのCNCで動作させることができると考えています。

また、CNCをCODESYSでラダーや簡易的なロボット連携できる恩恵は計り知れません。


###拡張実装の方針

例えば、主軸回転数指令は、DIN66025にはありませんが、MコードにKパラメータを指定して、CODESYSのPOUの変数で受け取る事が出来ます。ここまで出来ていれば(CODESYSでは出来ていますが）、ユーザーの機械側で、主軸の制御にあわせてD/AやEhterCATのインバーターに回転数になるように値を書き込めばいいだけです。

一般的なCAD/CAMでSコードを利用していれば、送信前にS12345 を M60001 K12345に（テキストエディタなどで）単純に置換するだけです。拡張機能はM60000以上をCODESYSで利用する計画です。


###現在出来ている事

CODESYSのMotion系のいろいろなFBに、いろんな機能がありますが、CNCの内部的な理解がないと、マニュアルやＷＥＢのヘルプを見ても、理解しがたいのではないかと思います。
また、複数のFBをどのように組み合わせれば思った機能が実現できるのか、UIとFBとGコードの組み合わせ、作りこみにも時間と手間がかかります。正しく動くことはもちろん、そこから性能や容量の限界などを実機のメモリやCPU等の限界とあわせて調整していくことになります。

本プロジェクトでは、汎用のCNCに近いものをRPiとCODESYSで実装し、どこまで実現できるのか、どこまで性能が発揮できるのか、仮想機能や実機でテストできるようにして、ユーザーの作りこみ、性能や安定性の実用のベースになるものになるプロジェクトを目指しています。


###現在出来ている事

・4000行の3D-CAD出力のXYZのG-Code（NURBS曲線を微小線分に分割）したものを、滑らかに補間しながら動作させる






