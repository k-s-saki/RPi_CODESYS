# RPi_CODESYS_CNC

Raspberry Pi + CODESYS(SoftMotion CNC/ROBOTICS) でどこまで汎用の(FANUCやSIEMENS等の）CNCに近いものが作れるか挑戦しています。

現時点では、EtherCATで設定し、サーボドライブが無くても実行・検証できるよう、仮想EtherCATドライブで実行できるようにしています。

PCで仮想サーボドライブで正しく実装されたら、RPi+EtherCATサーボドライブでテストしてみようと思います。

EtherCATデバイス（ACサーボドライブの機材など）で、もし不要なものがありましたら、譲渡・貸与頂けると、とても助かります。

---

## 開発の経緯と意義

CODESYSのCNCは、DIN66025のGコードをサポートしますが、一般的なCNCに比べると機能が限られています。

DIN66025についてはこちら
https://help.codesys.com/webapp/_sm_cnc_din66025_basics;product=codesys_softmotion;version=4.6.0.0

CODESYSのCNC機能で機械システムを作ろうとしたときに、DIN66025にはないFANUCやSIEMENSのCNCのGコード機能をどのように実装していいか、どういう機能がどれくらい出来るのか、出来ないのか、マニュアル等ではよくわからないのが実情です。

良い点としては、CODESYSでは、

1. 6万以上のMコードをユーザーが自由に使用して拡張ができ、２つの浮動小数のパラメータを渡すことができます。

2. Gコード内にキーワードを置いて、実行中のCODESYS内の変数で置換して使用することができます。

これらを使い、PC側で単純な置換をすることで、CNCのプログラムをCODESYSのCNCで動作させることができると考えています。

また、CNCをCODESYSでラダーや簡易的なロボット連携できる恩恵は計り知れません。


---

### 拡張実装の方針

例えば、主軸回転数指令は、DIN66025にはありませんが、MコードにKパラメータを指定して、CODESYSのPOUの変数で受け取る事が出来ます。ここまで出来ていれば(CODESYSでは出来ていますが）、ユーザーの機械側で、主軸の制御にあわせてD/AやEhterCATのインバーターに回転数になるように値を書き込めばいいだけです。

一般的なCAD/CAMでSコードを利用していれば、送信前にS12345 を M60001 K12345に（テキストエディタなどで）単純に置換するだけです。拡張機能はM60000以上をCODESYSで利用する計画です。


---

### 現在CNCとして出来ている事

・4000行の3D-CAD出力のXYZのG-Code（NURBS曲線を微小線分に分割）したものを、滑らかに補間しながら動作させる
・Mコードデバッグの機能（エラー時、終了時）
・DCSオフセット座標のリアルタイム表示
・主軸回転数の機能


### CNCとしての制限や拡張を検討していること

・一般的によくあるMコードをとりあえず入れる予定
・Gコードの容量は4000行として、POU:CNCに宣言しています。（変更可能）
・Mコードをサーボ制御タスクではなくて、ユーザーのタスク(10ms-20ms等）で制御できる工夫。👆現時点では、ユーザータスクでMコードを処理すると、Mコードが連続するときにMFINの同期の問題が出ます。

・工具長・径補正のテーブルを作り、補正テーブル番号で補正値を指定すること。
・DCSテーブルを作り、テーブル番号でDCSを指定すること。


---

### 個人的に思っていること

CODESYSのMotion系のいろいろなFBに、いろんな機能がありますが、CNCの内部的な理解がないと、マニュアルやＷＥＢのヘルプを見ても、理解しがたいと思います。

また、FBを理解できても、複数のFBをどのように組み合わせれば思った機能が実現できるのか、UIとFBとGコードの組み合わせ、作りこみにも時間と手間がかかります。正しく動くことはもちろん、そこから性能や容量の限界などを実機のメモリやCPU等の限界とあわせて調整していくことになります。

本プロジェクトでは、汎用のCNCに近いものをRPiとCODESYSで実装し、どこまで実現できるのか、どこまで性能が発揮できるのか、仮想機能や実機でテストできるようにして、ユーザーの作りこみ、性能や安定性の実用のベースになるものになるプロジェクトを目指しています。

RPiであれば、2時間機械は稼働できます。

本プロジェクトをCODESYSの学習、中小企業のAIやDXの活用、人手不足に役立てて頂けたら幸いです。講習等については、仕事の合間をつくって、可能な限り引き受けています。

### CODESYSの利点と日本企業のFA機材の利点

本プロジェクトと同様のCODESYSを使っていれば、本プロジェクトから不必要な画面や機能、使用しないサーボ軸等を削除し、各社のPLCやモーションコントローラに対応し、各機械にあわせたものにするのは簡単ではないかと思います。

現在、ある有名な日本企業のコントローラに移植しています。プロジェクトでデバイスを変更すると、CODESYSのバージョンの違いからエラーが出る所がほんの少しありますが、修正は簡単です。

これだけの機能が、PCとIoTをベースとしてRPiでプロトタイプや検証をおこなったあとで、信頼・実績・保守のある日本企業のPLCに簡単に変換でき、加えて各社のサーボモータ・ステッピングモータが容量、構造などを問わず、自由に組み合わせて使えるのは驚きです。

